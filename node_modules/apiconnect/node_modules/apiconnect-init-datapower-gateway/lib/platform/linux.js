/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/

'use strict';

const os      = require('os');
const dv      = require('apiconnect-mgmt-lite-datapower/lib/docker-validate');
const run     = require('../run');

const DOCKER_PLATFORM = 'Docker CE';
const INSTALL_URL = 'https://docs.docker.com/engine/installation/#supported-platforms';
const POST_INSTALL_URL = 'https://docs.docker.com/engine/installation/linux/linux-postinstall/';
const COMPOSE_INSTALL_URL = 'https://docs.docker.com/compose/install';
const INSTALL_MSG = `To install ${DOCKER_PLATFORM}, please visit ${INSTALL_URL}
      and choose your Linux distribution for further instruction.

      Then, please complete the steps to manage docker as a non-root user found here:
      ${POST_INSTALL_URL}

      Finally, if docker-compose is not installed, please install it by completing the Linux installation steps found here:
      ${COMPOSE_INSTALL_URL}`;

const ERRORS = {
  'DOCKER_NOT_FOUND': () => {
    return `
      It appears that ${DOCKER_PLATFORM} has not been installed. 
      ${INSTALL_MSG}`;
  },

  'DOCKER_NOT_ACCESSIBLE': () => {
    return `
      A required command appears to either not exist or cannot be executed. This may mean that ${DOCKER_PLATFORM} has not
      been installed, or the current user does not have permission to use it.
      
      If ${DOCKER_PLATFORM} has been installed, please ensure you are able to run it, or re-install it.
      
      ${INSTALL_MSG}`;
  },

  'DOCKER_COMPOSE_NOT_INSTALLED': () => {
    return `
      It appears that docker-compose is not installed. Please install it by completing the Linux installation steps
      found at ${COMPOSE_INSTALL_URL}`;
  },

  'BAD_VERSION': msg => {
    let cmd = 'docker(?:-compose)?';
    let ver = '\\d+(?:\\.\\d+)+(?:-ce)?';
    let pattern = `(${cmd}) version (${ver}) or greater is required. Current version: (${ver})`;
    let regex = new RegExp(pattern);
    let infostr = msg.replace(regex, (match, cmd, minver, curver) => `${cmd}\t${minver}\t${curver}`);

    // If we don't get a match for some reason...
    if (msg === infostr)
      return msg;

    // Otherwise...
    let info = infostr.split('\t');
    return `
      It appears that an unsupported version of Docker or ${DOCKER_PLATFORM} has been installed.
      We found ${info[0]} version ${info[3]}, but version ${info[2]} or greater is required.
      
      Please ensure you have the latest version of ${DOCKER_PLATFORM}.
      
      ${INSTALL_MSG}`;
  },

  'INSUFFICIENT_CPU': msg => {
    let regex = /Must have at least 2 CPUs available to docker, your system has (\d+)/;
    let cpus = msg.replace(regex, (match, n) => n);

    // If we don't get a match for some reason...
    if (msg === cpus)
      return msg;

    // Otherwise...
    return `
      Docker must have at least 2 CPUs available, but your system only makes ${cpus} CPUs available to it. If you are
      running ${DOCKER_PLATFORM} in a virtual machine, please ensure that it has at least 2 CPUs.
      
      Also, please ensure that there are at least 4 GB of memory available to Docker.`;
  },

  'INSUFFICIENT_MEM': msg => {
    let regex = /Must have at least 4 GB of memory available to docker, your system has (\d+) GB/;
    let mem = msg.replace(regex, (match, n) => n);

    // If we don't get a match for some reason...
    if (msg === mem)
      return msg;

    // Otherwise...
    return `
      Docker must have at least 4 GB of memory, but your system only makes ${mem} GB available to it. If you are
      running ${DOCKER_PLATFORM} in a virtual machine, please ensure that it has at least 4 GB of memory.
      
      Also, please ensure that there are at least 2 CPUs available to Docker.`;
  },

  'DOCKER_GROUP': () => {
    return `
      The current user must be a member of the docker group.
      
      Please complete the steps to manage docker as a non-root user found here:
      ${POST_INSTALL_URL}`;
  },

  'UNKNOWN_COMMAND_ERROR': msg => {
    let regex = /"(.+)" exited with non-zero status: (\d+)/;
    let infostr = msg.replace(regex, (match, cmd, code) => `${cmd}\t${code}`);

    // If we don't get a match for some reason...
    if (msg === infostr)
      return msg;

    // Otherwise...
    let info = infostr.split('\t');
    return `
      The following command exited with non-zero status: ${info[0]}
      The exit status was ${info[1]}
      
      This was an unexpected error. Please contact support for further assistance`;
  },

  'NON_ZERO_CHILD_EXIT_STATUS': result => {
    let stdout = result.stdout.replace(/^/gm, '        ');
    let stderr = result.stderr.replace(/^/gm, '        ');
    return `
      The following command exited with non-zero status: ${result.cmdstr}
      The exit status was ${result.exitStatus}
      
      The following was written to stdout:\n${stdout}
      
      The following was written to stderr:\n${stderr}
      
      This was an unexpected error. Please contact support for further assistance`;
  },

  'DOCKER_DAEMON_NOT_STARTED': () => {
    return `
      It seems that the Docker daemon is not running at the moment. Please start the Docker daemon.`;
  }
};

const error = require('../error-generator')(ERRORS);

exports.name = () => `Linux (release ${os.release()})`;

exports.validate = () => {
  return run('docker', ['--version'])
    .then(() => dv.validate())
    .catch(err => {
      if (err.code === 'ENOENT' ||
          / must be installed!/.test(err.message) ||
          /"which docker" exited with non-zero status/.test(err.message))
        throw error('DOCKER_NOT_FOUND');
      if (/"which docker-compose" exited with non-zero status/.test(err.message))
        throw error('DOCKER_COMPOSE_NOT_INSTALLED');
      if (err.code === 'EACCES')
        throw error('DOCKER_NOT_ACCESSIBLE');
      if (/docker(?:-compose)? version .+ or greater is required/.test(err.message))
        throw error('BAD_VERSION', err.message);
      if (/Must have at least 2 CPUs available to docker/.test(err.message))
        throw error('INSUFFICIENT_CPU', err.message);
      if (/Must have at least 4 GB of memory available to docker/.test(err.message))
        throw error('INSUFFICIENT_MEM', err.message);
      if (err.message === 'Current user must be a member of docker group')
        throw error('DOCKER_GROUP');
      if (/exited with non-zero status/.test(err.message))
        throw error('UNKNOWN_COMMAND_ERROR', err.message);
      if (/docker info/.test(err.message))
        throw error('DOCKER_DAEMON_NOT_STARTED');
      throw err;
    });
};


