/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apiconnect-apim-client
'use strict';

var f = require('util').format;
var testSupport = require('apiconnect-cli-test-support');
var nock = require('nock');
var path = require('path');

var moduleRoot = path.resolve(__dirname, '..');
var apic = testSupport.apic(moduleRoot);
var auth = testSupport.auth(apic);
var conf = testSupport.config;
var logger = testSupport.logger;
var test = testSupport.stackerTest;

var testCatalog = 'hcatalog';
var testOrg = 'climbon';
var subscriptionName = 'subscr_apimgmt_test_app_climb-on_9a';
var product = 'climb-on';
var prodVersion = 'climb-on:1.0.0';
var prodVersionPlan = 'climb-on:1.0.0:default';

function startMockServer(server, organization, catalog, prod, subscriptionId) {
  nock('https://' + server)
    .get('/v1/orgs/' + organization + '/environments/' + catalog + '/subscriptions')
    .reply(200, [
      {
        application: {
          name: 'apimgmt_test_app',
          appName: 'APIMGMT_TEST_APP',
          appId: '57ea9f3ee4b08413031e3b80',
          appDescription: 'Test application',
          clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
          enabled: true,
          state: 'ACTIVE',
          testApp: true,
          allowToFeatureApp: false,
          orgId: '57ea9f3be4b08413031e3b60',
          appCredentials: [
            {
              id: '57ea9f3ee4b08413031e3b81',
              clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
              description: null,
            },
          ],
        },
        product: {
          id: '57eaba2ee4b08413031e3e0e',
          name: 'climb-on',
          title: 'Climb On',
          version: '1.0.0',
          state: 'published',
        },
        plan: {
          id: 'climb-on:1.0.0:default',
          name: 'default',
          title: 'Default Plan',
        },
        id: '57eabc20e4b08413031e3ea8',
        name: 'subscr_apimgmt_test_app_climb-on_9a',
        approved: true,
        createdAt: '2016-09-27T18:36:16.507+0000',
        updatedAt: '2016-09-27T18:36:16.507+0000',
      },
    ])
    .get('/v1/orgs/' + organization + '/environments/' + catalog + '/subscriptions/?product=' + prod)
    .reply(200, [
      {
        application: {
          name: 'apimgmt_test_app',
          appName: 'APIMGMT_TEST_APP',
          appId: '57ea9f3ee4b08413031e3b80',
          appDescription: 'Test application',
          clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
          enabled: true,
          state: 'ACTIVE',
          testApp: true,
          allowToFeatureApp: false,
          orgId: '57ea9f3be4b08413031e3b60',
          appCredentials: [
            {
              id: '57ea9f3ee4b08413031e3b81',
              clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
              description: null,
            },
          ],
        },
        product: {
          id: '57eaba2ee4b08413031e3e0e',
          name: 'climb-on',
          title: 'Climb On',
          version: '1.0.0',
          state: 'published',
        },
        plan: {
          id: 'climb-on:1.0.0:default',
          name: 'default',
          title: 'Default Plan',
        },
        id: '57eabc20e4b08413031e3ea8',
        name: 'subscr_apimgmt_test_app_climb-on_9a',
        approved: true,
        createdAt: '2016-09-27T18:36:16.507+0000',
        updatedAt: '2016-09-27T18:36:16.507+0000',
      },
    ])
    .get('/v1/orgs/' + organization + '/environments/' + catalog + '/subscriptions/' + subscriptionId)
    .reply(200, {
      application: {
        name: 'apimgmt_test_app',
        appName: 'APIMGMT_TEST_APP',
        appId: '57ea9f3ee4b08413031e3b80',
        appDescription: 'Test application',
        clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
        enabled: true,
        state: 'ACTIVE',
        testApp: true,
        allowToFeatureApp: false,
        orgId: '57ea9f3be4b08413031e3b60',
        appCredentials: [
          {
            id: '57ea9f3ee4b08413031e3b81',
            clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
            description: null,
          },
        ],
      },
      product: {
        id: '57eaba2ee4b08413031e3e0e',
        name: 'climb-on',
        title: 'Climb On',
        version: '1.0.0',
        state: 'published',
      },
      plan: {
        id: 'climb-on:1.0.0:default',
        name: 'default',
        title: 'Default Plan',
      },
      id: '57eabc20e4b08413031e3ea8',
      name: 'subscr_apimgmt_test_app_climb-on_9a',
      approved: true,
      createdAt: '2016-09-27T18:36:16.507+0000',
      updatedAt: '2016-09-27T18:36:16.507+0000',
    });
}

test('setup', function(t) {
  return auth.login();
});

test('subscriptions', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog);
  logger.clear();
  return apic(f('subscriptions --scope catalog -c %s -o %s -s %s',
    testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('subscriptions:list', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog);
  logger.clear();
  return apic(f('subscriptions:list --scope catalog -c %s -o %s -s %s',
    testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('subscriptions:list using product', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, product);
  logger.clear();
  return apic(f('subscriptions:list -p %s --scope catalog -c %s -o %s -s %s',
    product, testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('subscriptions:list using product & version', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, prodVersion);
  logger.clear();
  return apic(f('subscriptions:list -p %s --scope catalog -c %s -o %s -s %s',
    prodVersion, testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('subscriptions:list using product & version & plan', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, prodVersionPlan);
  logger.clear();
  return apic(f('subscriptions:list -p %s --scope catalog -c %s -o %s -s %s',
    prodVersionPlan, testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('negative: subscriptions:list [no catalog]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog);
  logger.clear();
  return apic(f('subscriptions:list --scope catalog -o %s -s %s', testOrg, conf.getServer()))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --catalog option is required.');
    });
});

test('negative: subscriptions:list [no org]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog);
  logger.clear();
  return apic(f('subscriptions:list --scope catalog -c %s -s %s', testCatalog, conf.getServer()))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --organization option is required.');
    });
});

test('negative: subscriptions:list [no server]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog);
  logger.clear();
  return apic(f('subscriptions:list --scope catalog -c %s -o %s', testCatalog, testOrg))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --server option is required.');
    });
});

test('subscriptions:get', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, null, subscriptionName);
  logger.clear();
  return apic(f('subscriptions:get %s --scope catalog -c %s -o %s -s %s',
    subscriptionName, testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output[0], f('name: %s', subscriptionName));
      t.equals(output[1], 'app: APIMGMT_TEST_APP');
      t.equals(output[2], 'product: climb-on');
      t.equals(output[3], 'catalog: hcatalog');
      t.equals(output[4], 'organization: climbon');
    });
});

test('negative: subscriptions:get [no catalog]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, null, subscriptionName);
  logger.clear();
  return apic(f('subscriptions:get %s --scope catalog -o %s -s %s',
    subscriptionName, testOrg, conf.getServer()))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --catalog option is required.');
    });
});

test('negative: subscriptions:get [no org]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, null, subscriptionName);
  logger.clear();
  return apic(f('subscriptions:get %s --scope catalog -c %s -s %s',
    subscriptionName, testCatalog, conf.getServer()))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --organization option is required.');
    });
});

test('negative: subscriptions:get [no server]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, null, subscriptionName);
  logger.clear();
  return apic(f('subscriptions:get %s --scope catalog -c %s -o %s',
    subscriptionName, testCatalog, testOrg))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --server option is required.');
    });
});

