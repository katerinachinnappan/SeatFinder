/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apiconnect-apim-client
'use strict';

var f = require('util').format;
var testSupport = require('apiconnect-cli-test-support');
var nock = require('nock');
var path = require('path');

var moduleRoot = path.resolve(__dirname, '..');
var apic = testSupport.apic(moduleRoot);
var auth = testSupport.auth(apic);
var conf = testSupport.config;
var logger = testSupport.logger;
var test = testSupport.stackerTest;

var testCatalog = 'hcatalog';
var testOrg = 'climbon';
var subscriptionName = 'subscr_apimgmt_test_app_climb-on_9a';
var app = 'APIMGMT_TEST_APP';

function startMockServer(server, organization, catalog, app) {
  nock('https://' + server)
    .get('/v1/orgs/' + organization + '/environments/' + catalog + '/subscriptions?app=' + app)
    .reply(200, [
      {
        application: {
          name: 'apimgmt_test_app',
          appName: 'APIMGMT_TEST_APP',
          appId: '57ea9f3ee4b08413031e3b80',
          appDescription: 'Test application',
          clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
          enabled: true,
          state: 'ACTIVE',
          testApp: true,
          allowToFeatureApp: false,
          orgId: '57ea9f3be4b08413031e3b60',
          appCredentials: [
            {
              id: '57ea9f3ee4b08413031e3b81',
              clientId: '47604d0b-4a2d-4c10-aaa2-4959e0a479ae',
              description: null,
            },
          ],
        },
        product: {
          id: '57eaba2ee4b08413031e3e0e',
          name: 'climb-on',
          title: 'Climb On',
          version: '1.0.0',
          state: 'published',
        },
        plan: {
          id: 'climb-on:1.0.0:default',
          name: 'default',
          title: 'Default Plan',
        },
        id: '57eabc20e4b08413031e3ea8',
        name: 'subscr_apimgmt_test_app_climb-on_9a',
        approved: true,
        createdAt: '2016-09-27T18:36:16.507+0000',
        updatedAt: '2016-09-27T18:36:16.507+0000',
      },
    ]);
}

test('setup', function(t) {
  return auth.login();
});

test('subscriptions', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, app);
  logger.clear();
  return apic(f('subscriptions -a %s --scope consumer-org -c %s -o %s -s %s',
    app, testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('subscriptions:list', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, app);
  logger.clear();
  return apic(f('subscriptions:list -a %s --scope consumer-org -c %s -o %s -s %s',
    app, testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('subscriptions:list using application', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, app);
  logger.clear();
  return apic(f('subscriptions:list -a %s --scope consumer-org -c %s -o %s -s %s',
    app, testCatalog, testOrg, conf.getServer()))
    .then(function() {
      var output = logger.values();
      t.equals(output.length, 1);
      t.equals(output[0],
        f('%s in APIMGMT_TEST_APP for climb-on:1.0.0:default in climbon:hcatalog', subscriptionName));
    });
});

test('negative: subscriptions:list [no catalog]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, app);
  logger.clear();
  return apic(f('subscriptions:list -a %s --scope consumer-org -o %s -s %s',
    app, testOrg, conf.getServer()))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --catalog option is required.');
    });
});

test('negative: subscriptions:list [no org]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, app);
  logger.clear();
  return apic(f('subscriptions:list -a %s --scope consumer-org -c %s -s %s',
    app, testCatalog, conf.getServer()))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --organization option is required.');
    });
});

test('negative: subscriptions:list [no server]', function(t) {
  startMockServer(conf.getServer(), testOrg, testCatalog, app);
  logger.clear();
  return apic(f('subscriptions:list -a %s --scope consumer-org -c %s -o %s',
    app, testCatalog, testOrg))
    .then(t.fail)
    .catch(function(err) {
      t.ok(err);
      t.equals(err.message, 'The --server option is required.');
    });
});

