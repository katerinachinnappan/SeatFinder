/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apim-ui

'use strict';

angular.module('apim.account').controller('AccountController', ['$scope', '$rootScope', '$location', '$mdSidenav', 'CurrentUser',
  function AccountController($scope, $rootScope, $location, $mdSidenav, CurrentUser) {

    CurrentUser.query().$promise.then(function(data) {
        $scope.accountDetails = data
    })

    // Callback: Optional callback parameter for after save is done. Used by CMC's setup experience
    $scope.saveUser = function(callback) {
      var updatedUser = new CurrentUser(
        {
          'firstName': $scope.accountDetails.firstName,
          'lastName': $scope.accountDetails.lastName
        }
      );

      if ($scope.currentUser.name == 'admin' || $scope.currentUser.idpSummary.capabilities.updateEmail) {
        updatedUser.email = $scope.accountDetails.email;
      }

      if($scope.currentPassword && $scope.newPassword && $scope.newPasswordVerify) {
        updatedUser.oldPassword = $scope.currentPassword;
        updatedUser.password = $scope.newPassword;
      }

      var messageId = new Date().getTime();
      $scope.notifyUser('account-updating', [], "BUSY", false, messageId);
      var promise = updatedUser.$update();
      promise.then(
        function() {
          CurrentUser.query().$promise.then(function(data) {
            $rootScope.currentUser = data;
          })
          // $scope.isDirty = false;
          $scope.userForm.$setPristine();
          $scope.notifyUser('account-update-success', [], "SUCCESS", true, messageId);
          if (callback) {
            callback(true);
          }
          if ($rootScope.context == "cmc" && $scope.userSetup != "DONE") { window.location.reload(true); } // Pass in true to force it to reload from the server.
        },
        function() {
          $scope.notifyUser('account-update-failed', [], "ERROR", true, messageId);
          if (callback) {
            callback(false);
          }
        }
      );
    };

  }]);

