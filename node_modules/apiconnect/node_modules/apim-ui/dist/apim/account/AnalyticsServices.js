/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apim-ui

'use strict';

angular.module('apim.account')
  .service('AnalyticsServices', [
    '$rootScope',
    '$modal',
    'ConfigServices',
    'TrackingServices',
    AnalyticsServices
  ]);


function AnalyticsServices(
  $rootScope,
  $modal,
  ConfigServices,
  TrackingServices
){
  var svc = {};

  svc.setEnableAnalytics = function(skipAgreement, $scope){
    if (!skipAgreement && $scope.settings.analytics){
      return svc.agreeTerms($scope);
    }

    return TrackingServices.setEnableAnalytics($scope.settings.analytics)
      .then(function(enabled){
        $rootScope.analytics = Boolean(enabled);

        if (enabled) {
          var data = $rootScope.currentUser ? $rootScope.currentUser : {};

          return ConfigServices.deleteByName('analytics-reminder', true)
            .then(function(result){
              TrackingServices.identify(data)
            });
        }
      });
  };

  svc.agreeTerms = function($scope){
    return ConfigServices.getAnalyticsAgreement()
      .then(function(result){
        $scope.agreement = result.data.data;
        $scope.readOnly = false;
        $modal.open({
          templateUrl: 'apim/account/partials/agreement.html',
          windowTemplateUrl: 'apim/partials/main-template.html',
          controller: 'AccountAgreementController',
          size: 'md',
          scope: $scope,
          backdrop: 'static',
          keyboard: false
        });
      });
  };

  svc.showTerms = function($scope){
    return ConfigServices.getAnalyticsAgreement()
      .then(function(result){
        $scope.agreement = result.data.data;
        $scope.readOnly = true;
        $modal.open({
          templateUrl: 'apim/account/partials/agreement.html',
          windowTemplateUrl: 'apim/partials/main-template.html',
          controller: 'AccountAgreementController',
          size: 'md',
          scope: $scope
        });
      });
  };

  return svc;
}

