/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apim-ui

'use strict';

angular.module('apim.datasources')
  .directive('transformJson', function transformJson () {
    return {
      restrict: 'A',
      require: 'ngModel',
      link: function(scope, element, attrs, ngModel) {
        // Don't do anything unless we have a model
        if (ngModel) {
          ngModel.$parsers.push(function(value) {
            if (scope.setting.type === 'object' ||
              scope.setting.type === 'array') {
                try {
                  if (value === undefined || value === '') {
                    return undefined;
                  }
                  var obj = angular.fromJson(value);
                  if (scope.setting.type === 'array' && !Array.isArray(obj)) {
                    throw new Error('Value is not an array');
                  }
                  return obj;
                } catch (e) {
                  console.error(e);
                  console.error('Invalid JSON: ' + value);
                }
            } else {
              return value;
            }
          });

          ngModel.$formatters.push(function(value) {
            if (scope.setting.type === 'object' ||
              scope.setting.type === 'array') {
                return angular.toJson(value);
            } else {
              return value;
            }
          });
        }
      }
    };
  });

