/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2015, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apim-ui

'use strict';

angular.module('apim.apis').controller('AddApiWizardController', [
  '$scope',
  '$filter',
  'convertPlansToTagsFilter',
  'Api',
  'Product',
  addApiWizardController
]);

function addApiWizardController(
  $scope,
  $filter,
  convertPlansToTagsFilter,
  Api,
  Product
) {

  // These are filled out once we know what kind of thing they want to do
    $scope.currentPage = 0;
  $scope.pageCount = 99;

  $scope.chosenMethod = "SWAGGER_CREATE"; // "SWAGGER_CREATE", "SWAGGER_IMPORT", "WSDL_IMPORT", "OAUTH_CREATE"
  $scope.addToProductType = "none"; // "none", "new" [existing as future work]

  $scope.formValid = function() {
    // returns a boolean indicating whether the current panel is valid
  };

  var secPolicyName = $filter('translate')("clientId");
  $scope.newApi = {
    info: {
      version: "1.0.0"
    },
    securityDefinitions: {},
    security: []
  };
  $scope.newApi.securityDefinitions[secPolicyName] = {
    "description": "",
    "in":"header",
    "name":"X-IBM-Client-Id",
    "type":"apiKey"
  };
  var req = {};
  req[secPolicyName] = [];
  $scope.newApi.security.push(req);

  $scope.newProduct = {
    product: "1.0.0",
    info: {name: "", title: "", version: "1.0.0"},
    apis: [],
    plans: {}
  };
  $scope.newProduct.plans['Default'] = {title: $filter('translate')("product_default_plan_name"), apis: []};

  $scope.create = function() {
    var api = new Api($scope.newApi);
    $scope.creatingApi = true;
    api.$save({orgId: $scope.orgId, mode: "swagger2"}).then(function() {
      $scope.apis.push(api);

      if ($scope.addToProductType == "new") {
        $scope.newProduct.info.name = $scope.generateName($scope.newProduct.info.title);
        $scope.newProduct.apis = [{
          $ref: $scope.newApi.info["x-ibm-name"] + ":" + $scope.newApi.info.version
        }];
        $scope.newProduct.plans['Default'].apis = [{
          $ref: $scope.newApi.info["x-ibm-name"] + ":" + $scope.newApi.info.version
        }];
        var product = new Product($scope.newProduct);
        product.$create({orgId: $scope.orgId}).then(function() {
          $scope.creatingApi = false;
          // var topic = dojo.require("dojo/topic");
          // topic.publish("WA_API_C");
          //$modalInstance.close();
          window.location.hash = "#/author/apis/" + api.id;
        });
      } else {
        $scope.creatingApi = false;
        // var topic = dojo.require("dojo/topic");
        // topic.publish("WA_API_C");
        //$modalInstance.close();
        window.location.hash = "#/author/apis/" + api.id;
      }
    }, function() {
      $scope.creatingApi = false;
    });
  };
  $scope.cancel = function() {
    //$modalInstance.dismiss('cancel');
  };
  $scope.next = function() {
    $scope.currentPage++;
  };
  $scope.back = function() {
    $scope.currentPage--;
  };
  $scope.selected = function(item) {
    $scope.selectedPlans.push(item);
    $scope.userInput = null;
  };
};

