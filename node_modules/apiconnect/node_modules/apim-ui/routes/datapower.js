/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apim-ui
'use strict';

var uuid = require('uuid');
var express = require('express');
var router = express.Router();
var startScript = require('apiconnect-init-datapower-gateway');
var INIT_SESSIONS = {};

router.get('/startScript', function (req, res) {
  var config = req.query;
  var id = uuid.v4();
  INIT_SESSIONS[id] = [];

  Object.keys(config).forEach(function (k) {
    config[k] = config[k] === 'true';
  });

  startScript(config, function(log){
    INIT_SESSIONS[id].push(log);
  }).catch(err => {
    INIT_SESSIONS[id].push(`Error: ${err.message}`);
  });
  res.send({'id': id});
});

router.get('/logs/:id', function(req, res) {
  var id = req.params.id;
  var logs = INIT_SESSIONS[id];
  if (logs === undefined)
    return res.sendStatus(404);
  INIT_SESSIONS[id] = [];
  res.send(logs);
});

module.exports = router;
