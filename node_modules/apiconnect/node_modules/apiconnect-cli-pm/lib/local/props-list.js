/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apiconnect-cli-pm

'use strict';

var Promise = require('bluebird');
var _ = require('lodash');
var client = require('./util/client');
var filter = require('./util/props-filter').filter;
var servicesList = require('./services-list').listImpl;

module.exports = listProps;

function listProps(options) {
  options = options || {};
  client.init(options);
  var namesPromise = Promise.resolve([ options.service ]);
  if (!options.service) {
    // If we don't have a service name, use the services api
    // to get a list of all service names
    namesPromise = servicesList(options).then(function(services) {
      return services.map(function(service) {
        return _.get(service, 'name');
      });
    });
  };

  return namesPromise.then(function(serviceNames) {
    var getServicesPromises = serviceNames.map(function(service) {
      return client.getService(service);
    });
    return Promise.all(getServicesPromises);
  }).then(function(services) {
    return _.map(services, function(service) {
      return {
        app: service.name,
        props: filter(service.env),
      };
    });
  });
}

