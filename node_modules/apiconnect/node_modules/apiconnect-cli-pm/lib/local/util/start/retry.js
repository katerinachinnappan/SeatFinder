/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apiconnect-cli-pm

'use strict';

var async = require('async');
var debug = require('debug')('apiconnect-cli-pm:poll');
var timeout = require('../config').get('startTimeout');

// Call poll until it doesn't callback with err... delaying a bit between call.
// Args: retry(poll[, tries], callback)
module.exports = function retry(_poll, tries, callback) {
  if (!callback) {
    callback = tries;
    tries = 10;
  } else {
    tries = +tries || 10;
  }
  var delay = timeout / tries;

  async.retry(tries, poll, callback);

  function poll(callback) {
    debug('Polling');
    _poll(function(err) {
      if (!err) {
        return callback();
      }

      setTimeout(function() {
        callback(err);
      }, delay);
    });
  }
};

