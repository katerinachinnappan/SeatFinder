/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 *
 * (C) Copyright IBM Corporation 2016, 2018
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
describe('generator-worker', function() {

  var worker;

  beforeEach(function() {
    worker = new Worker("base/dist/scripts/worker-debug.js");
  });

  it('should flatten', function(done){

    var definitionsSection = {
      "address": {
        "properties": {
          "street1": {
            "type": "string"
          },
          "street2": {
            "type": "string"
          },
          "city": {
            "type": "string"
          },
          "state": {
            "type": "string"
          },
          "zip_code": {
            "type": "string"
          }
        },
        "description": "address details",
        "additionalProperties": false
      },
      "inventory": {
        "properties": {
          "inventory_id": {
            "type": "string"
          },
          "product_id": {
            "type": "string"
          },
          "quantity": {
            "type": "number",
            "format": "double"
          },
          "store_id": {
            "type": "string"
          }
        },
        "required": [
          "inventory_id"
        ],
        "additionalProperties": false
      },
      "review": {
        "properties": {
          "review_id": {
            "type": "string"
          },
          "date": {
            "type": "string",
            "format": "date"
          },
          "reviewer_name": {
            "type": "string"
          },
          "reviewer_email": {
            "type": "string"
          },
          "rating": {
            "type": "number",
            "format": "double"
          },
          "comment": {
            "type": "string"
          },
          "product_id": {
            "type": "string"
          }
        },
        "required": [
          "review_id"
        ],
        "additionalProperties": false
      },
      "store": {
        "description": "store information",
        "properties": {
          "store_id": {
            "type": "string"
          },
          "address": {
            "$ref": "#/definitions/address"
          },
          "phone": {
            "type": "string"
          },
          "hours": {
            "type": "string"
          }
        },
        "required": [
          "store_id"
        ],
        "additionalProperties": false
      },
      "product": {
        "description": "product catalog and reviews",
        "properties": {
          "product_id": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "image": {
            "type": "string"
          },
          "price": {
            "type": "number",
            "format": "double"
          },
          "rating": {
            "type": "number",
            "format": "double"
          }
        },
        "required": [
          "product_id"
        ],
        "additionalProperties": false
      },
      "customer": {
        "description": "operations for customer accounts",
        "properties": {
          "id": {
            "type": "string"
          },
          "first_name": {
            "type": "string"
          },
          "last_name": {
            "type": "string"
          },
          "email": {
            "type": "string"
          },
          "address": {
            "$ref": "#/definitions/address"
          },
          "dob": {
            "type": "string",
            "format": "date"
          }
        },
        "required": [
          "id"
        ],
        "additionalProperties": false
      }
    };
    var schema = {
      definitions: definitionsSection
    };
    var expectedDefinitionsSection = {
      "address": {
        "properties": {
          "street1": {
            "type": "string"
          },
          "street2": {
            "type": "string"
          },
          "city": {
            "type": "string"
          },
          "state": {
            "type": "string"
          },
          "zip_code": {
            "type": "string"
          }
        },
        "description": "address details",
        "additionalProperties": false
      },
      "inventory": {
        "properties": {
          "inventory_id": {
            "type": "string"
          },
          "product_id": {
            "type": "string"
          },
          "quantity": {
            "type": "number",
            "format": "double"
          },
          "store_id": {
            "type": "string"
          }
        },
        "required": [
          "inventory_id"
        ],
        "additionalProperties": false
      },
      "review": {
        "properties": {
          "review_id": {
            "type": "string"
          },
          "date": {
            "type": "string",
            "format": "date"
          },
          "reviewer_name": {
            "type": "string"
          },
          "reviewer_email": {
            "type": "string"
          },
          "rating": {
            "type": "number",
            "format": "double"
          },
          "comment": {
            "type": "string"
          },
          "product_id": {
            "type": "string"
          }
        },
        "required": [
          "review_id"
        ],
        "additionalProperties": false
      },
      "store": {
        "description": "store information",
        "properties": {
          "store_id": {
            "type": "string"
          },
          "address": {
            "properties": {
              "street1": {
                "type": "string"
              },
              "street2": {
                "type": "string"
              },
              "city": {
                "type": "string"
              },
              "state": {
                "type": "string"
              },
              "zip_code": {
                "type": "string"
              }
            },
            "description": "address details #/definitions/address",
            "additionalProperties": false
          },
          "phone": {
            "type": "string"
          },
          "hours": {
            "type": "string"
          }
        },
        "required": [
          "store_id"
        ],
        "additionalProperties": false
      },
      "product": {
        "description": "product catalog and reviews",
        "properties": {
          "product_id": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "image": {
            "type": "string"
          },
          "price": {
            "type": "number",
            "format": "double"
          },
          "rating": {
            "type": "number",
            "format": "double"
          }
        },
        "required": [
          "product_id"
        ],
        "additionalProperties": false
      },
      "customer": {
        "description": "operations for customer accounts",
        "properties": {
          "id": {
            "type": "string"
          },
          "first_name": {
            "type": "string"
          },
          "last_name": {
            "type": "string"
          },
          "email": {
            "type": "string"
          },
          "address": {
            "properties": {
              "street1": {
                "type": "string"
              },
              "street2": {
                "type": "string"
              },
              "city": {
                "type": "string"
              },
              "state": {
                "type": "string"
              },
              "zip_code": {
                "type": "string"
              }
            },
            "description": "address details #/definitions/address",
            "additionalProperties": false
          },
          "dob": {
            "type": "string",
            "format": "date"
          }
        },
        "required": [
          "id"
        ],
        "additionalProperties": false
      }
    };
    var expectedSchema = {
      schema: {
        definitions: expectedDefinitionsSection
      }
    };
    // test resolving references now
    var tosend = {
      schema: schema,
      type: 'resolveReferences'
    };

    worker.onmessage = function(event) {
      expect(event.data).toBeDefined();
      expect(event.data).toEqual(expectedSchema, "expected flattened schema");

      done();
    };

    worker.onerror = function(error) {
      console.error("Test error: " + error.message + ", " + error.filename + ":" + error.lineno);
      console.error(error);
    };

    worker.postMessage(tosend);

  });
});
