version: '2.1'

services:
  datapower-api-gateway:
    build: datapower
    image: ibm-apiconnect-toolkit/datapower-api-gateway:${APICONNECT_MGMT_LITE_DOCKER_TAG:-latest}
    restart: always
    links:
      - "datapower-mgmt-server-lite"
    ports:
      - ${APICONNECT_MGMT_LITE_PORT_80:-80}
      - ${APICONNECT_MGMT_LITE_PORT_9443:-9443}
      - ${APICONNECT_MGMT_LITE_PORT_9090:-9090}
      - ${APICONNECT_MGMT_LITE_PORT_5554:-5554}
    volumes:
      - usrcerts-volume:/drouter/secure/usrcerts/apiconnect:ro

  datapower-mgmt-server-lite:
    build:
     context: .
     args:
       - IBM_APICONNECT_NPM_REGISTRY
       - HTTP_PROXY
       - HTTPS_PROXY
       - NO_PROXY
    image: ibm-apiconnect-toolkit/datapower-mgmt-server-lite:${APICONNECT_MGMT_LITE_DOCKER_TAG:-latest}
    restart: always
    ports:
      - ${APICONNECT_MGMT_LITE_PORT_2443:-2443}
    environment:
      - CONFIG_DIR=/tmp/project
      - TARGET_URL=${TARGET_URL}
      - CHOKIDAR_USEPOLLING=${CHOKIDAR_USEPOLLING-0}
      - PORT=${PORT}
      - IBM_APICONNECT_APIM_LITE_DOCKER_HOST=${IBM_APICONNECT_APIM_LITE_DOCKER_HOST}
      - IBM_APICONNECT_APIC_DEV_HOSTIP=${IBM_APICONNECT_APIC_DEV_HOSTIP}
      - LOG_TIMESTAMP=true
      - LOG_ANSI_STYLES=${LOG_ANSI_STYLES-false}
    volumes:
      - ${APICONNECT_MGMT_LITE_PROJECT_DIR:-./test}:/tmp/project:ro
      - usrcerts-volume:/tmp/generated:rw
      - ${HOME}/.apiconnect:/home/node/.apiconnect:ro

volumes:
  usrcerts-volume:
