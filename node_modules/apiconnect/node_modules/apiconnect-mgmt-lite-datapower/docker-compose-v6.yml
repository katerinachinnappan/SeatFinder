version: '2.1'

services:
  datapower-api-gateway:
    build: datapower-v6
    image: ibm-apiconnect-toolkit/datapower-api-gateway-v6:${APICONNECT_MGMT_LITE_DOCKER_TAG:-latest}
    restart: always
    links:
      - "datapower-gateway-director"
    ports:
      - ${APICONNECT_MGMT_LITE_PORT_80:-80}
      - ${APICONNECT_MGMT_LITE_PORT_9443:-9443}
      - ${APICONNECT_MGMT_LITE_PORT_9090:-9090}
      - ${APICONNECT_MGMT_LITE_PORT_5554:-5554}
    volumes:
      - local-volume:/drouter/local/apiconnect:ro
      - usrcerts-volume:/drouter/secure/usrcerts/apiconnect:ro

  datapower-gateway-director:
    build:
     context: .
     dockerfile: Dockerfile-v6
     args:
       - IBM_APICONNECT_NPM_REGISTRY
       - HTTP_PROXY
       - HTTPS_PROXY
       - NO_PROXY
    image: ibm-apiconnect-toolkit/datapower-gateway-director:${APICONNECT_MGMT_LITE_DOCKER_TAG:-latest}
    restart: always
    ports:
      - ${APICONNECT_MGMT_LITE_PORT_2443:-2443}
    environment:
      - CONFIG_DIR=/tmp/project
      - TARGET_URL=${TARGET_URL}
      - CHOKIDAR_USEPOLLING=${CHOKIDAR_USEPOLLING-0}
      - PORT=${PORT}
      - IBM_APICONNECT_APIM_LITE_DOCKER_HOST=${IBM_APICONNECT_APIM_LITE_DOCKER_HOST}
      - IBM_APICONNECT_APIC_DEV_HOSTIP
      - IBM_APICONNECT_APIC2DP_BAIL_ON_COMPILE_ERROR
      - DEBUG
    volumes:
      - ${APICONNECT_MGMT_LITE_PROJECT_DIR:-./test}:/tmp/project:rw
      - local-volume:/tmp/generated/local:rw
      - usrcerts-volume:/tmp/generated/usrcerts:rw
      - ${HOME}/.apiconnect:/home/node/.apiconnect:ro

volumes:
  local-volume:
  usrcerts-volume:
