top; configure terminal;

crypto
  certificate "cmc-webapi-sslsvr-apifsh-1" "config:///toolkit-gateway-cert.pem" ignore-expiration
  certificate "webapi-mgmt-client-pubcert" "config:///toolkit-gateway-cert.pem" ignore-expiration
  certificate "x2020_pubcert" "config:///toolkit-gateway-cert.pem" ignore-expiration
  key "cmc-webapi-sslsvr-apifsh-0" "config:///toolkit-gateway-key.pem"
  key "webapi-mgmt-client-privkey" "config:///toolkit-gateway-key.pem"
  key "x2020_privkey" "config:///toolkit-gateway-key.pem"
  sskey "webapi-oauth-token-ss" "config:///toolkit-oauth-aes256-ss.txt"
  idcred "cmc-webapi-sslsvr-apifsh" "cmc-webapi-sslsvr-apifsh-0" "cmc-webapi-sslsvr-apifsh-1"
  profile "cmc-webapi-sslsvr-apifsh" "cmc-webapi-sslsvr-apifsh" option-string OpenSSL-default+Disable-SSLv2+Disable-SSLv3 ciphers "HIGH:MEDIUM:!aNULL:!eNULL:!RC4:@STRENGTH" clientcalist off
exit

sslproxy "cmc-webapi-sslsvr-apifsh" "reverse" "cmc-webapi-sslsvr-apifsh" sess-timeout "300" cache-size "20"

crypto
  ssl-server "cmc-webapi-sslsvr-apifsh"
    protocols "TLSv1d0+TLSv1d1+TLSv1d2"
    ciphers ECDHE_RSA_WITH_AES_256_GCM_SHA384
    ciphers ECDHE_RSA_WITH_AES_256_CBC_SHA384
    ciphers ECDHE_RSA_WITH_AES_256_CBC_SHA
    ciphers DHE_DSS_WITH_AES_256_GCM_SHA384
    ciphers DHE_RSA_WITH_AES_256_GCM_SHA384
    ciphers DHE_RSA_WITH_AES_256_CBC_SHA256
    ciphers DHE_DSS_WITH_AES_256_CBC_SHA256
    ciphers DHE_RSA_WITH_AES_256_CBC_SHA
    ciphers DHE_DSS_WITH_AES_256_CBC_SHA
    ciphers RSA_WITH_AES_256_GCM_SHA384
    ciphers RSA_WITH_AES_256_CBC_SHA256
    ciphers RSA_WITH_AES_256_CBC_SHA
    ciphers ECDHE_RSA_WITH_AES_128_GCM_SHA256
    ciphers ECDHE_RSA_WITH_AES_128_CBC_SHA256
    ciphers ECDHE_RSA_WITH_AES_128_CBC_SHA
    ciphers DHE_DSS_WITH_AES_128_GCM_SHA256
    ciphers DHE_RSA_WITH_AES_128_GCM_SHA256
    ciphers DHE_RSA_WITH_AES_128_CBC_SHA256
    ciphers DHE_DSS_WITH_AES_128_CBC_SHA256
    ciphers DHE_RSA_WITH_AES_128_CBC_SHA
    ciphers DHE_DSS_WITH_AES_128_CBC_SHA
    ciphers RSA_WITH_AES_128_GCM_SHA256
    ciphers RSA_WITH_AES_128_CBC_SHA256
    ciphers RSA_WITH_AES_128_CBC_SHA
    ciphers ECDHE_RSA_WITH_3DES_EDE_CBC_SHA
    ciphers DHE_RSA_WITH_3DES_EDE_CBC_SHA
    ciphers DHE_DSS_WITH_3DES_EDE_CBC_SHA
    ciphers RSA_WITH_3DES_EDE_CBC_SHA
    idcred cmc-webapi-sslsvr-apifsh
    no request-client-auth
    require-client-auth
    no validate-client-cert
    send-client-auth-ca-list
    caching
    cache-timeout 300
    cache-size 20
    ssl-options ""
    max-duration 60
    max-renegotiation-allowed 0
    no prohibit-resume-on-reneg
    no compression
    no allow-legacy-renegotiation
    prefer-server-ciphers
    curves secp521r1
    curves secp384r1
    curves secp256k1
    curves secp256r1
  exit

  ssl-sni-mapping "cmc-webapi-sslsvr-apifsh"
    sni-mapping "*" "cmc-webapi-sslsvr-apifsh"
  exit

  ssl-sni-server "cmc-webapi-sslsvr-apifsh"
    protocols "TLSv1d0+TLSv1d1+TLSv1d2"
    sni-server-mapping cmc-webapi-sslsvr-apifsh
    sni-server-default cmc-webapi-sslsvr-apifsh
    ssl-options ""
    max-duration 3600
    max-renegotiation-allowed 0
  exit
exit

loadbalancer-group "mgmt-lb"
  algorithm round-robin
  server "datapower-mgmt-server-lite" "20" "2443" "" "0" "enabled"
  health-check
    admin-state
    target-uri "/v1/catalogs/status"
    target-port 2443
    no use-soap
    timeout 15
    frequency 15
    xpath "/status[normalize-space(.) = 'ok']"
    enforce-timeout
    independent-checks
    request-doc "store:///healthcheck.json"
    request-content-type "application/json"
    response-evaluator store:///healthcheck.js
    tcp-conn-type Full
    ssl-client-type client
    ssl-client webapi-sslcli-mgmt
  exit
exit

loadbalancer-group "analytics-lb"
  algorithm round-robin
  server "datapower-mgmt-server-lite" "20" "2443" "" "0" "enabled"
  health-check
    admin-state
    target-uri "/v1/catalogs/status"
    target-port 2443
    no use-soap
    timeout 15
    frequency 15
    xpath "/status[normalize-space(.) = 'ok']"
    enforce-timeout
    independent-checks
    request-doc "store:///healthcheck.json"
    request-content-type "application/json"
    response-evaluator store:///healthcheck.js
    tcp-conn-type Full
    ssl-client-type client
    ssl-client webapi-sslcli-mgmt
  exit
exit

source-http webapi-http
  allowed-features HTTP-1.0+HTTP-1.1+POST+GET+PUT+HEAD+OPTIONS+DELETE+CustomMethods+QueryString+FragmentIdentifiers
  local-address :: 9080
exit

deployment-policy "apigateway"
   filter */*/crypto/key?Name=.*
   filter */*/crypto/cert?Name=.*
   filter */*/crypto/sskey?Name=.*
   filter */*/network/loadbalancer-group?Name=.*
   filter */*/protocol/https?Name=webapi-https-2
   modify
     match */*/services/multiprotocol-gateway?Name=webapi&Property=FrontProtocol&Value=webapi-https-2
     type delete
   exit
   modify
     match */*/xml/xmlmgr?Name=webapi-internal&Property=DocCacheSize
     type change
     value "130862284"
   exit
   modify
     match */*/protocol/https?Name=.*&Property=LocalAddress
     type change
     value "0.0.0.0"
   exit
   modify
     match */*/protocol/https?Name=webapi-https&Property=LocalPort
     type change
     value "9443"
   exit
   modify
     match */*/crypto/ssl-client?Name=api-sslcli-x2020&Property=ValidateServerCert
     type change
     value "off"
   exit
   modify
     match */*/services/multiprotocol-gateway?Name=webapi
     type add
     name "FrontProtocol"
     value "webapi-http"
   exit
   modify
    match */*/mgmt/wsm-agent?Property=PushSubscribers/URL
    type change
    value "https://datapower-mgmt-server-lite:2443/x2020/v1/events/_bulk"
   exit
exit

import-package "apigateway"
  source-url "https://datapower-mgmt-server-lite:2443/apigateway.zip"
  deployment-policy apigateway
exit

import-execute "apigateway"

set-system-var var://system/_apimgmt/apiconnect/use-circuit-breaker 0
