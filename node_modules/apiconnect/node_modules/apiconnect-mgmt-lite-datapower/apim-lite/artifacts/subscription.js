/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apiconnect-mgmt-lite-datapower

'use strict';

const _      = require('lodash');
const Path   = require('path');
const utils  = require('./utils');
const logger = require('../../common/logger');
const genid  = require('../../common/genid');

const API = require('./api');
const Product = require('./product');

const SUBSCRIPTIONS = new Map();

exports.clear = () => {
  SUBSCRIPTIONS.clear();
};

exports.get = id => SUBSCRIPTIONS.get(id);

exports.size = () => SUBSCRIPTIONS.size;

exports.array = () => Array.from(SUBSCRIPTIONS.values());

function generatePlan(product, planName) {
  return {
    apis: product.document.apis,
    id: `${product.document.info.name}:${product.document.info.version}:${planName}`,
    plan: {
      name: planName,
      title: product.document.plans[planName].title,
    },
    product: product,
  };
}

exports.generate =  (catalog, config) => {
  exports.clear();
  Product.array().forEach(product => {
    let apis = Object.keys(product.document.apis).map(name => {
      return API.getByName(product.document.apis[name].name);
    });
    Object.keys(product.document.plans).forEach(planName => {
      let id = genid();
      let doc = {
        catalog: catalog,
        application: {
          'oauth-redirection-uri': config.genOAuthRedirectUri(),
          'oauth-client-type': config.getOAuthClientType(),
          'app-credentials': [{
            'client-id': 'default',
            'client-secret': 'CRexOpCRkV1UtjNvRZCVOczkUrNmGyHzhkGKJXiDswo='
          }],
          title: 'Default Application',
          description: 'Default Application',
          enabled: true,
          id: genid(),
          state: 'ACTIVE',
          'test-app': false,
        },
        organization: catalog.organization,
        'developer-organization': catalog.organization,
        url: `https://mgmt-lb:2443/v1/catalogs/${catalog.id}/subscriptions/${id}`,
        id: id,
        'plan-registration': {
          apis: apis,
          id: `${product.document.info.name}:${product.document.info.version}:${planName}`,
          plan: {
            name: planName,
            title: product.document.plans[planName].title,
          },
          product: product,
        },
        active: true,
      };
      SUBSCRIPTIONS.set(id, doc);
    });
  });
};

