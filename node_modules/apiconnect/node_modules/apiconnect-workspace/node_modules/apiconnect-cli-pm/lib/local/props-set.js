/********************************************************* {COPYRIGHT-TOP} ***
 * Licensed Materials - Property of IBM
 * 5725-Z22, 5725-Z63, 5725-U33, 5725-Z63
 *
 * (C) Copyright IBM Corporation 2016, 2017
 *
 * All Rights Reserved.
 * US Government Users Restricted Rights - Use, duplication or disclosure
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 ********************************************************** {COPYRIGHT-END} **/
// Node module: apiconnect-cli-pm

'use strict';

var Promise = require('bluebird');
var _ = require('lodash');
var client = require('./util/client');
var errors = require('./util/errors');
var filter = require('./util/props-filter').filter;
var names = require('./util/name-helper');

module.exports = setProps;

function setProps(kv, otherKVs, opts) {
  opts = opts || {};
  client.init(opts);

  kv = _.concat([], kv, otherKVs);
  kv = _.fromPairs(_.map(kv, function(v) {
    return v.split('=');
  }));
  kv = filter(kv);

  var namesPromise = Promise.resolve(opts.service);
  if (!opts.service) {
    namesPromise = names(null, true);
  }

  return namesPromise.then(function(serviceName) {
    if (!serviceName) {
      throw errors.nonProjectDir('apic props:set');
    }
    return client.getService(serviceName);
  }).then(function(service) {
    // create env vars for the specified service
    return service.setEnvsAsync(kv)
      .then(function() {
        return service.refreshAsync();
      }).return({ app: service.name, props: kv });
  });
}

