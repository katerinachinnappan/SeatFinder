# apiconnect-collective-jmx

## Overview
The apiconnect-collective-jmx library provides helper functions for
communicating with a WAS Liberty Collective, as well as JMX encoding tools to
allow creation of custom JMX messages.

## Usage
Install by running `npm i --save apiconnect-collective-jmx`.

## Pre-defined Modules
This toolkit comes with a collection of modules and functions for
performing operations against a collective.

#### Example
```js
var jmx = require('apiconnect-collective-jmx');
var path = require('path');
var payload = jmx.collective.registerHost({
  rpcHost: 'someHost',
  rpcUser: 'someUser',
  sshPrivateKey: path.resolve('path', 'to', 'key_rsa');
});
```

For a full list, see the [API Reference](#api-reference).

## Make your own JMX requests
If there are no helper libraries defined for the JMX calls you'd like
to make, then you have the option of defining your own using the same
common modules used throughout this toolkit.

### Simple Example
Using the Encoder, Payload and Endpoint objects, you can construct a JMX
payload with the Encoder, target the REST resource with the Payload and then
send the request to a specific server with Endpoint!

```js
var jmx = require('apiconnect-collective-jmx');
var Encoder = jmx.Encoder;
var Payload = jmx.Payload;
var Endpoint = jmx.Endpoint;
var url = require('url');

// Make an encoder instance.
var encoder = new Encoder();

// Add parameters in order!
// Pretend we're calling an endpoint that takes a title (string), a size (int)
// and whether or not it's available (boolean).
encoder.addString('foo');
encoder.addNumber(2);
encoder.addBoolean(true);
// Send a JMX payload to {host:port}/targetResource!
var payload = new Payload('/targetResource', 'POST', encoder.encodeJson());

// Can also take a 3rd options param!
var controller = new Endpoint('localhost', '9443');

// Give it the payload, options and a callback!
controller.request(payload, {}, function(err, response) {
  if (err) console.error('oh noes!');
  else {
    console.log('Made a new widget!');
    console.log(response);
  }
});

```

## Advanced Usage

### Types
Here are the Java types available on the Encoder's `types` object:
- JavaObject (java.lang.Object)
- String (java.lang.String)
- Integer (java.lang.Integer)
- Double (java.lang.Double)
- Boolean (java.lang.Boolean)
- HashMap (java.util.HashMap)
- ArrayList (java.util.ArrayList)

Using these static type definitions will simplify your usage, and
help avoid typos within Java types on your payloads.
See the examples below for usage of the `Encoder.types` collection.

### Add an Array

```js
var names = ['foo', 'bar' ];
var encoder = new Encoder();
encoder.addArray(names, encoder.types.String);
```

### Add a Map

```js
var map = {
  'foo': 2,
  'bar': 3,
};
var encoder = new Encoder();
encoder.addMap(map, encoder.types.String, encoder.types.Integer);
```

### Add a Custom Value
Using the encoder doesn't limit you to the predefined types! In fact, you
can create your own custom entries with the `addSimpleValue` function.

If you know the expected Java type at the target API level, you can specify
it as a string!

```js
var widgetInstance = getMagicWidget();
var encoder = new Encoder();

encoder.addSimpleValue(widgetInstance, 'com.foobar.Widget', 'java.lang.Object');
```

# API Reference
## Modules

<dl>
<dt><a href="#module_apiconnect-collective-jmx">apiconnect-collective-jmx</a></dt>
<dd></dd>
</dl>

## Classes

<dl>
<dt><a href="#Collective">Collective</a></dt>
<dd></dd>
<dt><a href="#Encoder">Encoder</a></dt>
<dd></dd>
<dt><a href="#Endpoint">Endpoint</a></dt>
<dd></dd>
<dt><a href="#Payload">Payload</a></dt>
<dd></dd>
<dt><a href="#RouterClient">RouterClient</a></dt>
<dd></dd>
<dt><a href="#Types">Types</a></dt>
<dd></dd>
</dl>

<a name="module_apiconnect-collective-jmx"></a>

## apiconnect-collective-jmx
<a name="Collective"></a>

## Collective
**Kind**: global class  

* [Collective](#Collective)
    * [new Collective()](#new_Collective_new)
    * [.COLLECTIVE_REGISTRATION_MBEAN](#Collective.COLLECTIVE_REGISTRATION_MBEAN)
    * [.Join(options)](#Collective.Join)
    * [.Remove(options)](#Collective.Remove)
    * [.registerHost(options)](#Collective.registerHost)
    * [.unregisterHost(options)](#Collective.unregisterHost)
    * [.updateHost(options)](#Collective.updateHost)

<a name="new_Collective_new"></a>

### new Collective()
Operations for registering and unregistering host machines,
as well as joining and removing applications from a collective.

<a name="Collective.COLLECTIVE_REGISTRATION_MBEAN"></a>

### Collective.COLLECTIVE_REGISTRATION_MBEAN
The path string for collective registration operations on a Liberty JMX
collective controller.

**Kind**: static property of [<code>Collective</code>](#Collective)  
<a name="Collective.Join"></a>

### Collective.Join(options)
Generates the JMX command to join a member server to a collective.

**Kind**: static method of [<code>Collective</code>](#Collective)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.hostName | <code>string</code> | The hostname of the member. |
| options.wlpUserDir | <code>string</code> | The path on the host to the 'usr' folder that contains the member. |
| options.serverName | <code>string</code> | The name of the member to join to the collective. |
| options.wlpInstallDir | <code>string</code> | The directory of the wlp installation. |
| options.keystorePassword | <code>string</code> | The password for the certificates generated as a part of the collective join operation. |
| [options.certProperties] | <code>object</code> | An options object for changing the behaviours of certificate generation. |
| options.hostAuthInfo | <code>object</code> | An options object for defining properties used by the collective to remotely access the host machine of the member. |
| [options.rpcHost] | <code>string</code> | The Host address of the remote server |
| [options.rpcUser] | <code>string</code> | The username of an account |
| [options.rpcUserHome] | <code>string</code> | The UserHome directory of rpcUser that can run RPC commands against the host. Does not apply if SSH is used. |
| [options.rpcPort] | <code>string</code> | The RPC port of the member host. Does not apply if SSH is used. |
| [options.rpcUserPassword] | <code>string</code> | The password for the user account running RPC commands. Does not apply if SSH is used. |
| [options.hostAuthInfo.sudoUser] | <code>string</code> | On systems where "sudo" is available, this will be the username of a sudoer for elevating SSH commands. Only applies to SSH. |
| [options.sudoPassword] | <code>string</code> | The password for the sudoer. Only applies to SSH. |
| [options.sshPublicKeyPath] | <code>string</code> | The path to the SSH public key. |
| [options.sshPrivateKeyPath] | <code>string</code> | The path to the SSH private key. |
| [options.sshPrivateKeyPassword] | <code>string</code> | The password for the SSH private key. |
| [options.useHostCredentials] | <code>boolean</code> | Tells the member to inherit its credentials configuration from the host's configuration (requires the host to already have been registered with the collective). |
| [options.hostReadList] | <code>Array</code> | The list of locations on the host with allowed read access. |
| [options.hostWriteList] | <code>Array</code> | The list of locations on the host with allowed write access. |

<a name="Collective.Remove"></a>

### Collective.Remove(options)
Generates the JMX command to remove a member server from a collective.

**Kind**: static method of [<code>Collective</code>](#Collective)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.hostName | <code>string</code> | The hostname of the member. |
| options.wlpUserDir | <code>string</code> | The path on the host to the 'usr' folder that contains the member. |
| options.serverName | <code>string</code> | The name of the member to join to the collective. |

<a name="Collective.registerHost"></a>

### Collective.registerHost(options)
Generates the JMX command to register a host in a collective.

**Kind**: static method of [<code>Collective</code>](#Collective)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.hostName | <code>string</code> | The hostname of the member. |
| [options.rpcHost] | <code>string</code> | The Host address of the remote server |
| [options.rpcUser] | <code>string</code> | The username of an account |
| [options.rpcUserHome] | <code>string</code> | The UserHome directory of rpcUser that can run RPC commands against the host. Does not apply if SSH is used. |
| [options.rpcPort] | <code>string</code> | The RPC port of the member host. Does not apply if SSH is used. |
| [options.rpcUserPassword] | <code>string</code> | The password for the user account running RPC commands. Does not apply if SSH is used. * @param {string=} options.sshPrivateKeyPath - The path to the SSH private key. |
| [options.sshPrivateKeyPassword] | <code>string</code> | The password for the SSH private key. |

<a name="Collective.unregisterHost"></a>

### Collective.unregisterHost(options)
Generates the JMX command to unregister a host.

**Kind**: static method of [<code>Collective</code>](#Collective)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.hostName | <code>string</code> | The hostname of the member. |

<a name="Collective.updateHost"></a>

### Collective.updateHost(options)
Generates the JMX command to update a host info.

**Kind**: static method of [<code>Collective</code>](#Collective)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.hostName | <code>string</code> | The hostname of the member. |
| [options.rpcHost] | <code>string</code> | The Host address of the remote server |
| [options.rpcUser] | <code>string</code> | The username of an account |
| [options.rpcUserHome] | <code>string</code> | The UserHome directory of rpcUser that can run RPC commands against the host. Does not apply if SSH is used. |
| [options.rpcPort] | <code>string</code> | The RPC port of the member host. Does not apply if SSH is used. |
| [options.rpcUserPassword] | <code>string</code> | The password for the user account running RPC commands. Does not apply if SSH is used. * @param {string=} options.sshPrivateKeyPath - The path to the SSH private key. |
| [options.sshPrivateKeyPassword] | <code>string</code> | The password for the SSH private key. |

<a name="Encoder"></a>

## Encoder
**Kind**: global class  

* [Encoder](#Encoder)
    * _instance_
        * [.clearPayload()](#Encoder+clearPayload)
        * [.encodeJson()](#Encoder+encodeJson) ⇒ <code>Object</code> \| <code>\*</code> \| <code>Object</code>
        * [.addBoolean(val)](#Encoder+addBoolean)
        * [.addString(val)](#Encoder+addString)
        * [.addInteger(val)](#Encoder+addInteger)
        * [.addDouble(val)](#Encoder+addDouble)
        * [.addList(arr, type)](#Encoder+addList)
        * [.addArray(arr, type)](#Encoder+addArray)
        * [.addMap(map, keyType, valueType, [isComplexKey])](#Encoder+addMap)
        * [.addEntryToMap(hashMap, value, key, keyType, valueType, [isComplexKey])](#Encoder+addEntryToMap)
        * [.addSimpleValue(val, type, [baseType])](#Encoder+addSimpleValue)
    * _static_
        * [.types](#Encoder.types)

<a name="Encoder+clearPayload"></a>

### encoder.clearPayload()
Clear the payload contained within the JMX object (if you want to reuse it).

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  
<a name="Encoder+encodeJson"></a>

### encoder.encodeJson() ⇒ <code>Object</code> \| <code>\*</code> \| <code>Object</code>
Prepare a JMX object in JSON based on the existing payload in this object.

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  
<a name="Encoder+addBoolean"></a>

### encoder.addBoolean(val)
Add a boolean to the JMX payload.

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Type |
| --- | --- |
| val | <code>boolean</code> | 

<a name="Encoder+addString"></a>

### encoder.addString(val)
Add a string to the JMX payload.

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Type |
| --- | --- |
| val | <code>string</code> | 

<a name="Encoder+addInteger"></a>

### encoder.addInteger(val)
Add an integer to the JMX payload.

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Type |
| --- | --- |
| val | <code>number</code> | 

<a name="Encoder+addDouble"></a>

### encoder.addDouble(val)
Add a double to the JMX payload.

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Type |
| --- | --- |
| val | <code>number</code> | 

<a name="Encoder+addList"></a>

### encoder.addList(arr, type)
Add a list to the JMX object (Java's ArrayList in JSON form).

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Description |
| --- | --- |
| arr | The array of objects to add to the payload. All items must be of the same type! |
| type | The Java data-type of the values within the array. |

<a name="Encoder+addArray"></a>

### encoder.addArray(arr, type)
Add an array to the JMX object (different than List/ArrayList, requires
special string annotations for type).

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Description |
| --- | --- |
| arr | The array of objects to add to the payload. All items must be of the same type! |
| type | The Java data-type of the values within the array. |

<a name="Encoder+addMap"></a>

### encoder.addMap(map, keyType, valueType, [isComplexKey])
Add a Map (HashMap) to the JMX payload.

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| map | <code>\*</code> |  | The JSON object that acts as your map. |
| keyType | <code>string</code> |  | The Java type of the keys. |
| valueType | <code>string</code> |  | The Java type of the values. |
| [isComplexKey] | <code>boolean</code> | <code>false</code> | Whether or not the Java data type of the keys are complex or simple. Defaults to false (simple). |

<a name="Encoder+addEntryToMap"></a>

### encoder.addEntryToMap(hashMap, value, key, keyType, valueType, [isComplexKey])
Add a Map (HashMap) to the JMX payload.

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| hashMap | <code>\*</code> |  | The JSON object that acts as your map. |
| value | <code>string</code> |  | The value to be put in the map |
| key | <code>string</code> |  | The key for the value in the map |
| keyType | <code>string</code> |  | The Java type of the keys. |
| valueType | <code>string</code> |  | The Java type of the values. |
| [isComplexKey] | <code>boolean</code> | <code>false</code> | Whether or not the Java data type of the keys are complex or simple. Defaults to false (simple). |

<a name="Encoder+addSimpleValue"></a>

### encoder.addSimpleValue(val, type, [baseType])
Add a simple value to the JMX payload; does not support complex data types!

**Kind**: instance method of [<code>Encoder</code>](#Encoder)  

| Param | Type | Description |
| --- | --- | --- |
| val | <code>\*</code> | The value to insert into the payload. |
| type | <code>string</code> | The Java data-type of the value. |
| [baseType] | <code>string</code> | The baseType of the object (only added to signature!) |

<a name="Encoder.types"></a>

### Encoder.types
The list of pre-defined Java types available for use in JMX payloads.

**Kind**: static property of [<code>Encoder</code>](#Encoder)  
**See**: Types  
<a name="Endpoint"></a>

## Endpoint
**Kind**: global class  
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| options.acceptUnauthorized | <code>string</code> | Accept unauthorized HTTPS certificates if the server uses them. Common during initial join. |
| options.checkServerIdentity | <code>string</code> | Whether to verify that server's hostname matches the CN in the TLS certificate. Defaults to `true`. |
| options.ca | <code>string</code> | A PEM encoded CA certificate to trust as as an HTTPS certificate issuer. |
| options.username | <code>string</code> | The username used for Basic auth with the endpoint. |
| options.password | <code>string</code> | The password used for Basic auth with the endpoint. |
| options.pfx | <code>string</code> | The client identity. |
| options.pfxPassphrase | <code>string</code> | The pfx passphrase. |
| options.request | <code>function</code> | Inject a request function compatible with the request module (useful for faking calls to a remote target). |


* [Endpoint](#Endpoint)
    * [new Endpoint(host, port, [options])](#new_Endpoint_new)
    * [.request(payload, options, cb)](#Endpoint+request)

<a name="new_Endpoint_new"></a>

### new Endpoint(host, port, [options])
Represents a target server and resource to submit requests against.


| Param | Type | Description |
| --- | --- | --- |
| host | <code>string</code> | The IP address of the host. |
| port | <code>number</code> \| <code>string</code> | The port to connect to. |
| [options] | <code>object</code> | Additional options for function overrides and for request-specific configuration vars. |

<a name="Endpoint+request"></a>

### endpoint.request(payload, options, cb)
Submit JMX requests to target endpoint.

**Kind**: instance method of [<code>Endpoint</code>](#Endpoint)  

| Param | Type | Description |
| --- | --- | --- |
| payload | [<code>Payload</code>](#Payload) | The JMX payload to submit to the endpoint. |
| options | <code>object</code> | The options object. |
| cb | <code>function</code> | Handle the server's response. |

<a name="Payload"></a>

## Payload
**Kind**: global class  
<a name="new_Payload_new"></a>

### new Payload(path, verb, data, [qs])

| Param | Type | Description |
| --- | --- | --- |
| path | <code>string</code> | The path to the resource. |
| verb | <code>string</code> | The REST verb of the request. |
| data | <code>object</code> | The JMX body of the request. Must be a JSON object, not a string! |
| [qs] | <code>string</code> | An optional query string to apply to the payload. |

<a name="RouterClient"></a>

## RouterClient
**Kind**: global class  

* [RouterClient](#RouterClient)
    * [new RouterClient()](#new_RouterClient_new)
    * [.SetApplicationRoutingInfo(options, operation)](#RouterClient.SetApplicationRoutingInfo)
    * [.SetApplicationState(options, operation)](#RouterClient.SetApplicationState)
    * [.SetEndPointRoutingInfo(options, operation)](#RouterClient.SetEndPointRoutingInfo)

<a name="new_RouterClient_new"></a>

### new RouterClient()
JMX operations for configuring application and endpoint routing information.

<a name="RouterClient.SetApplicationRoutingInfo"></a>

### RouterClient.SetApplicationRoutingInfo(options, operation)
Sets the application routing information. The application routing info
is the address which is mapped to the user application. This URL includes
context root, as well as virtual host address and vHost port. The router
client redirects the request to this application if it finds the requested
url the address which is set by this method.

**Kind**: static method of [<code>RouterClient</code>](#RouterClient)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.host | <code>string</code> | The host on which the server is running. |
| options.userDir | <code>string</code> | The user directory in which the server is set up. |
| options.server | <code>string</code> | The server name associated to the server. |
| options.applicationName | <code>string</code> | The application name. |
| options.contextRoot | <code>string</code> | The context root if routing by context root (the value is / if not). |
| options.vHost | <code>string</code> | The virtual host address if routing by virtual host (the value is * unless otherwise). |
| options.vHostPort | <code>string</code> | The virtual host port if routing by virtual host (the value is * unless otherwise) |
| operation | <code>string</code> | The operation to set/delete/create a value in the collective repository of the controller. |

<a name="RouterClient.SetApplicationState"></a>

### RouterClient.SetApplicationState(options, operation)
Sets the application routing information. The application routing info
is the address which is mapped to the user application. This URL includes
context root, as well as virtual host address and vHost port. The router
client redirects the request to this application if it finds the requested
url the address which is set by this method.

**Kind**: static method of [<code>RouterClient</code>](#RouterClient)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.host | <code>string</code> | The host on which the server is running. |
| options.userDir | <code>string</code> | The user directory in which the server is set up. |
| options.server | <code>string</code> | The server name associated to the server. |
| options.applicationName | <code>string</code> | The application name. |
| operation | <code>string</code> | The operation to set/delete/create a value in the collective repository of the controller. |

<a name="RouterClient.SetEndPointRoutingInfo"></a>

### RouterClient.SetEndPointRoutingInfo(options, operation)
Sets the end point routing information. This information includes the
address and port that application is running. There are 12 attributes values
which are sent to the controller. these attributes are defined in enum
called attributes which includes host, workport, etc.

**Kind**: static method of [<code>RouterClient</code>](#RouterClient)  

| Param | Type | Description |
| --- | --- | --- |
| options | <code>object</code> | The options object. |
| options.host | <code>string</code> | The host on which the server is running. |
| options.userDir | <code>string</code> | The user directory in which the server is set up. |
| options.server | <code>string</code> | The server name associated to the server. |
| options.attribute | <code>string</code> | The attribute type to be set. |
| options.attributeValue | <code>string</code> | The attribute value to be set. |
| operation | <code>string</code> | The operation to set/delete/create a value in the collective repository of the controller. |

<a name="Types"></a>

## Types
**Kind**: global class  

* [Types](#Types)
    * [.ArrayList](#Types.ArrayList)
    * [.Boolean](#Types.Boolean)
    * [.HashMap](#Types.HashMap)
    * [.Integer](#Types.Integer)
    * [.JavaObject](#Types.JavaObject)
    * [.String](#Types.String)

<a name="Types.ArrayList"></a>

### Types.ArrayList
A resizable array implemention of Java's List interface.
[https://docs.oracle.com/javase/7/docs/api/java/util/ArrayList.html](https://docs.oracle.com/javase/7/docs/api/java/util/ArrayList.html)

**Kind**: static property of [<code>Types</code>](#Types)  
<a name="Types.Boolean"></a>

### Types.Boolean
A single-bit representation of a truth value, either being "true" or
"false".
[https://docs.oracle.com/javase/7/docs/api/java/lang/Boolean.html](https://docs.oracle.com/javase/7/docs/api/java/lang/Boolean.html)

**Kind**: static property of [<code>Types</code>](#Types)  
<a name="Types.HashMap"></a>

### Types.HashMap
A hash-table based implementation of the Map interface.
[https://docs.oracle.com/javase/7/docs/api/java/util/HashMap.html](https://docs.oracle.com/javase/7/docs/api/java/util/HashMap.html)

**Kind**: static property of [<code>Types</code>](#Types)  
<a name="Types.Integer"></a>

### Types.Integer
A number without decimal places.
[https://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html](https://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html)

**Kind**: static property of [<code>Types</code>](#Types)  
<a name="Types.JavaObject"></a>

### Types.JavaObject
The base class for all other classes in the class hierarchy.
[https://docs.oracle.com/javase/7/docs/api/java/lang/Object.html](https://docs.oracle.com/javase/7/docs/api/java/lang/Object.html)

**Kind**: static property of [<code>Types</code>](#Types)  
<a name="Types.String"></a>

### Types.String
An immutable array of alphanumeric characters.
[https://docs.oracle.com/javase/7/docs/api/java/lang/String.html](https://docs.oracle.com/javase/7/docs/api/java/lang/String.html)

**Kind**: static property of [<code>Types</code>](#Types)  
