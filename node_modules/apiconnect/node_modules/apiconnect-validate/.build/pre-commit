#!/bin/sh

exec 2>&1
hash readlink 2>/dev/null && export READLINK=readlink
hash greadlink 2>/dev/null && export READLINK=greadlink

#-------------------------------------------------------------------------------
# Walk up the directory hierarchy until REPOSITORY_DIR is the directory that
# contains the .git repository directory.
#-------------------------------------------------------------------------------
REPOSITORY_DIR=`pwd`
DONE=false
while [[ "$REPOSITORY_DIR" != "/" && "$DONE" == "false" ]]; do
    if [[ -d "$REPOSITORY_DIR/.git" ]]; then
        DONE=true
    else
        REPOSITORY_DIR=$REPOSITORY_DIR/..
        REPOSITORY_DIR=$($(READLINK) -f $REPOSITORY_DIR)
    fi
done

#-------------------------------------------------------------------------------
# Lint the code
#-------------------------------------------------------------------------------
echo "Linting..."
grunt lint > $REPOSITORY_DIR/.build/commit.log
if [[ $? != 0 ]]; then
    cat $REPOSITORY_DIR/.build/commit.log
    exit 1
fi

#-------------------------------------------------------------------------------
# If there is a openapi.yaml file, validate its semantics with Kona
#-------------------------------------------------------------------------------
if [[ -e $REPOSITORY_DIR/openapi/openapi.yaml ]]; then
     echo "Kona..."
     node $VELOX/kona/kona $REPOSITORY_DIR/openapi/openapi.yaml > $REPOSITORY_DIR/.build/commit.log
     if [[ $? != 0 ]]; then
         cat $REPOSITORY_DIR/.build/commit.log
        exit 1
     fi
fi

#-------------------------------------------------------------------------------
# Clean up and spit out the line count
#-------------------------------------------------------------------------------
rm -f $REPOSITORY_DIR/.build/commit.log
grunt -b $REPOSITORY_DIR loc
